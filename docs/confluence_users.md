# Инструкция для пользователей автотестов (ручные тестировщики)

Пользователь автотестов — это ручной тестировщик, который:
- запускает автотесты из CI/CD (пайплайн) **на своём стенде**
- умеет найти результат в TestOps (кейсы + testruns)
- расширяет покрытие “в ширину”, добавляя **datasets** под новые наборы данных (при наличии исходных данных/архива)

## 1) Что проверяют автотесты (в двух словах)
Автотесты **имитируют запросы фронта** в `api-gateway` по WebSocket (SignalR, messagepack) и проверяют ответы бэка.

Ключевое: мы проверяем те же “контракты”, которые использует UI, только без кликов.

## 2) Что считается “набором данных” (dataset / suite)
Один dataset = один файл конфигурации в `test_config/datasets/` (например `select_6.py`).  
Dataset определяет:
- какой архив данных имитатора использовать (`archive_name`)
- какие параметры утечки ожидать (координата/объём/окно времени)
- какие проверки включены (какие тесты “активны”)
- когда именно выполнять каждую проверку (`offset`, минуты)

## 3) Какие наборы данных покрыты сейчас
Текущий список suites (по файлам `test_config/datasets/select_*.py`):
- `Select_6_tn3_56km_113` — стационар, 1 утечка
- `Select_7_tn3_130km_113` — стационар, 1 утечка + расширенная проверка соседних ДУ
- `Select_4_tn3_215km_113` — режим остановленной перекачки (STOPPED), 1 утечка
- `Select_17_tn3_75km_417` — 1 утечка (больший объём/другие окна времени)
- `Select_19_20_tn3_75_181km_649` — **2 утечки** (multi‑leak), есть доп. тест на переход в НЕстационар

## 4) Запуск из пайпа (основной сценарий)

### Обязательная переменная
- **`STAND_NAME`** — имя стенда, на котором запускаем (например `dev1`, `test3` и т.п.).  
  Это влияет на:
  - адреса стенда (внутренний маппинг)
  - подготовку окружения (контейнеры, redis)
  - то, какой `api-gateway` будет использован для WS

### Вариант A: запуск “смоука” по suite через `SMOKE_PATH`
В пайпе задаётся переменная `SMOKE_PATH`, внутри которой будет часть команды после `pytest`:
- пример: `SMOKE_PATH=tests/test_smoke.py --suites=Select_6`

Важно про `--suites`:
- можно одно значение или список через запятую
- сравнение делается по подстроке (case-insensitive), поэтому можно писать коротко: `--suites=select_6`

### Вариант B: произвольный запуск через `TEST_PATH`
`TEST_PATH` — это полная команда, которая начинается с `pytest`:
- пример (одна проверка в конкретном suite):  
  `TEST_PATH=pytest tests/test_smoke.py --suites=select_19_20 -k "test_leaks_content"`

Когда нужен `TEST_PATH`:
- если надо запустить **один тест** (точечно)
- если надо комбинировать `--suites` и `-k`

## 5) Как запустить только один тест (точечно)

### Самый точный способ — nodeid pytest
Suite-level тест:
- `pytest tests/test_smoke.py::TestSuiteScenarios::test_basic_info[Select_6_tn3_56km_113]`

Leak-level тест (для multi‑leak есть суффикс `_leak_N`):
- `pytest tests/test_smoke.py::TestLeakScenarios::test_leaks_content[Select_19_20_tn3_75_181km_649_leak_1]`

### Быстрый способ — через `-k`
- `pytest tests/test_smoke.py --suites=select_6 -k "test_basic_info"`
- `pytest tests/test_smoke.py --suites=select_19_20 -k "test_leaks_content and leak_2"`

## 6) Где смотреть результат

### TestOps: тест‑кейсы (TMS)
В TestOps вы находите:
- тест‑кейс по `test_case_id` (он задан в datasets)
- описание, шаги, вложения (например архивы данных)

### TestOps: testruns (прогоны)
В testruns вы смотрите:
- статус прогона (passed/failed)
- шаги Allure и вложения (включая диагностические значения)
- группировку по suite (набору данных)

## 7) Как добавить новый dataset (покрытие “в ширину”)

### Когда это имеет смысл
- есть новый “отбор” (набор данных) и он нужен для регресса
- в TestOps (или в доступном хранилище) есть архив данных имитатора `.tar.gz`

### Как добавить (рецепт)
1) Скопировать похожий конфиг:
   - 1 утечка → взять `test_config/datasets/select_6.py`
   - 2 утечки → взять `test_config/datasets/select_19_20.py`
2) Переименовать файл на `select_XX.py` (важно: не начинать с `_`).
3) Внутри файла:
   - обновить `SUITE_NAME`, `SUITE_DATA_ID`, `ARCHIVE_NAME`
   - заполнить параметры утечки/утечек (координата/объём/интервалы)
   - заполнить `CaseMarkers` для нужных тестов:
     - `test_case_id` (из TestOps)
     - `offset` (минуты от старта набора)
4) Экспортировать переменную конфигурации с суффиксом **`_CONFIG`** (например `SELECT_21_CONFIG`).
5) Готово: configs подхватятся автоматически при импорте `test_config.datasets.ALL_CONFIGS`.

### Важные правила
- `offset` задаётся **в минутах** и используется для:
  - ожидания перед тестом
  - расчёта длительности имитатора для набора (max offset + задержка)
- Для multi‑leak:
  - используйте `leaks=[LeakTestConfig(...), LeakTestConfig(...)]`
  - id параметра будет `<suite_name>_leak_N`

## 8) FAQ
- **Почему тесты без UI?**  
  Потому что UI потребляет ответы `api-gateway`; мы проверяем тот же контракт, но стабильнее и быстрее.
- **Почему на разных наборах имитатор перезапускается?**  
  Набор данных = отдельный архив/сценарий имитатора, поэтому инфраструктура перезапускает стенд при смене suite.


